[gd_scene load_steps=6 format=2]

[ext_resource path="res://Assets/fireelemental.png" type="Texture" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends KinematicBody2D

onready var animation = $AnimationPlayer

const SPEED = 10
const GRAVITY = 200
const UP_VECTOR = Vector2(0,-1) #indicator, how the up direction is defined 

var velocity = Vector2()
var direction = 1 # 1 = right, -1 left

var is_climbing_ladder = false
var last_ladder_id = 0

# Called when the node enters the scene tree for the first time.
func _ready():
	pass # Replace with function body.


# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta):
	if  direction == 1:
		$Sprite.flip_h = false
	else:
		$Sprite.flip_h = true
	
	animation.play(\"moving\")
	if is_on_floor() and not is_climbing_ladder:
		velocity.y = 0
		
		if floor(position.x) == 216:
			direction = -1
			last_ladder_id = 0
		if floor(position.x) == 8:
			direction = 1
			last_ladder_id = 0
			
		velocity.x = direction * SPEED
	else:
		velocity.x = 0
		if not is_climbing_ladder:
			velocity.y += GRAVITY * delta # make fall faster the longer the fall

	ladder_test()
	handle_climb_platform()

	move_and_slide_with_snap(velocity, Vector2(0,1), UP_VECTOR)


func ladder_test():
	if not is_climbing_ladder:
		for area in $LadderBottomHitBox.get_overlapping_areas():
			if area.name.begins_with(\"LadderBottom\") and last_ladder_id != area.get_instance_id():
				last_ladder_id = area.get_instance_id()
				randomize()
				var random_val = randi() % 3 #33% chance of falling

				if random_val == 0:
					return
				elif random_val == 1:
					direction = direction * -1
				else:
					pass
					is_climbing_ladder = true
					position.y -= SPEED
	else:
		velocity.y = -1


	

func handle_climb_platform():
	# handle ascending platform climbing
	var raycast = null
	if direction == 1:
		raycast = $PlatformRayCastRight
	else:
		raycast = $PlatformRayCastLeft
		
	raycast.force_raycast_update()
	var collider = raycast.get_collider()
	if collider != null and collider.name.begins_with(\"Platform\"):
		position.y -= 1
	return false
		
"

[sub_resource type="RectangleShape2D" id=2]
extents = Vector2( 15, 10 )

[sub_resource type="Animation" id=3]
resource_name = "moving"
length = 0.8
loop = true
tracks/0/type = "value"
tracks/0/path = NodePath("Sprite:frame")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0, 0.4 ),
"transitions": PoolRealArray( 1, 1 ),
"update": 1,
"values": [ 0, 1 ]
}
tracks/1/type = "value"
tracks/1/path = NodePath("Sprite:position")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/keys = {
"times": PoolRealArray( 0, 0.4 ),
"transitions": PoolRealArray( 1, 1 ),
"update": 1,
"values": [ Vector2( 0, -9 ), Vector2( 0, -8 ) ]
}

[sub_resource type="RectangleShape2D" id=4]
extents = Vector2( 10, 8 )

[node name="FireElemental" type="KinematicBody2D"]
script = SubResource( 1 )

[node name="Sprite" type="Sprite" parent="."]
position = Vector2( 0, -8 )
texture = ExtResource( 1 )
vframes = 2
hframes = 2

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2( 0, -8 )
scale = Vector2( 0.4, 0.8 )
shape = SubResource( 2 )

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
anims/moving = SubResource( 3 )

[node name="LadderBottomHitBox" type="Area2D" parent="."]

[node name="CollisionShape2D" type="CollisionShape2D" parent="LadderBottomHitBox"]
position = Vector2( 0, -1 )
scale = Vector2( 0.05, 0.1 )
shape = SubResource( 4 )

[node name="PlatformRayCastRight" type="RayCast2D" parent="."]
position = Vector2( 6, 0 )
scale = Vector2( 0.2, 0.1 )
cast_to = Vector2( 1, 0 )

[node name="PlatformRayCastLeft" type="RayCast2D" parent="."]
position = Vector2( -6, 0 )
scale = Vector2( 0.2, 0.1 )
cast_to = Vector2( -1, 0 )
